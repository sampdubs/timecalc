<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Post-Conference Workshops - CRS Time Calculator</title>
    <meta name="author" content="Sam Prausnitz-Weinbaum">
    <meta name="description"
        content="This website can tell you what time the CRS 2020 conference will be at in your local time!">
</head>

<body style="font-family: Arial, Helvetica, sans-serif;">
    <h3><a href="/">â€¹Home</a></h3>
    <img src="../banner.jpg" width=100% />
    <div style="text-align: center;">
        <h1>Welcome to the Controlled Release Society post-conference workshops time calculator</h1>
    </div>
    <h3>Please enter your location:</h3>
    <div>
        <input type="text" id="loc" placeholder="Enter your location"
            style="width: 100%; height: 2em; font-size: larger;" />
    </div>
    <button id="go" style="height: 5%;font-size: larger; text-align: center; margin: 10px;">Update
        location</button>
    <br />
    <h2 id="time-label" style="background-color: white; display: inline-block;">Please enter your location</h2>
    <div style="text-align: center;" class="times">
        <h1 class="inner" id="live" style="background-color: white; display: inline-block;">...</h1>
    </div>
    <h2 class="times" style="background-color: white; display: inline-block;">The session will repeat at the following
        time:</h2>
    <div style="text-align: center;" class="times">
        <h1 class="inner" id="repeat" style="background-color: white; display: inline-block;">...</h1>
    </div>
    <!-- <h2 style="background-color: white; display: inline-block;">The sessions will be on demand during the
        following time:</h2>
    <div style="text-align: center;">
        <h1 id="on-demand" style="background-color: white; display: inline-block;">Some date - another date</h1>
    </div> -->
    <!-- <br>
    <br>
    <br>
    <div style="position: fixed; text-align: right; bottom: 0px; width: 100%; z-index: -1;">
        <p style="padding-right: 15px;">Like the website? Consider <a href="https://paypal.me/paysampw" 
                target="blank">donating to the developer</a>!</p>
    </div> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maps.google.com/maps/api/js?key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script>
        const loc = $("#loc");
        const go = $("#go");
        const live = $("#live");
        const liveTime = new Date("2020/07/01 07:00:00 -0400");
        const repeat = $("#repeat");
        const repeatTime = new Date("2020/07/01 18:00:00 -0400");
        const times = $(".times");
        times.hide();
        const geocoder = new google.maps.Geocoder();

        go.click(handler);
        loc.on('keyup', function (e) {
            if (e.keyCode === 13) {
                handler();
            }
        });

        function handler(lat, lng) {
            $(".inner").text("...");
            geocoder.geocode({ 'address': loc.val() }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    const latitude = results[0].geometry.location.lat();
                    const longitude = results[0].geometry.location.lng();
                    displayLocation(latitude, longitude);
                    let timestamp = liveTime.getTime() / 1000 + liveTime.getTimezoneOffset() * 60;

                    const method = 'GET';
                    const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + latitude + ',' + longitude + '&timestamp=' + timestamp + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

                    request = new XMLHttpRequest();

                    request.open(method, url);
                    request.onload = function () {
                        if (request.status === 200) {
                            const data = JSON.parse(request.responseText);
                            const offsets = data.dstOffset * 1000 + data.rawOffset * 1000; // get DST and time zone offsets in milliseconds

                            const options = { weekday: 'short', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };

                            let localdate = new Date(timestamp * 1000 + offsets);

                            $("#time-label").text("This session will take place at the following time:");
                            live.text(localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(5, 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }));

                            timestamp = repeatTime.getTime() / 1000 + repeatTime.getTimezoneOffset() * 60;
                            localdate = new Date(timestamp * 1000 + offsets);
                            repeat.text(localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(5, 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }));

                            times.show();
                        } else {
                            fail();
                        }
                    }
                    request.send();
                } else {
                    fail();
                }
            });
        }

        function fail() {
            times.hide();
            $("#time-label").text("Uh oh... something went wrong. Please try again.")
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function geoSuccess(position) {
            latitude = position.coords.latitude
            longitude = position.coords.longitude;
            displayLocation(latitude, longitude);
            let timestamp = liveTime.getTime() / 1000 + liveTime.getTimezoneOffset() * 60;
            const method = 'GET';
            const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + latitude + ',' + longitude + '&timestamp=' + timestamp + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

            request = new XMLHttpRequest();

            request.open(method, url);
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    const offsets = data.dstOffset * 1000 + data.rawOffset * 1000; // get DST and time zone offsets in milliseconds

                    const options = { weekday: 'short', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };

                    let localdate = new Date(timestamp * 1000 + offsets);

                    $("#time-label").text("This session will take place at the following time:");
                    live.text(localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(5, 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }));

                    timestamp = repeatTime.getTime() / 1000 + repeatTime.getTimezoneOffset() * 60;
                    localdate = new Date(timestamp * 1000 + offsets);
                    repeat.text(localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(5, 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }));

                    times.show();
                } else {
                    fail();
                }
            }
            request.send();
        }

        function geoError() {
            console.log("Geocoder failed.");
        }
        $(getLocation);

        function displayLocation(latitude, longitude) {
            let request = new XMLHttpRequest();

            const method = 'GET';
            const url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + latitude + ',' + longitude + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

            request.open(method, url, true);
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    const data = JSON.parse(request.responseText);

                    let final = ""
                    for (let i = 0; i < data.results.length; i++) {
                        element = data.results[i]
                        if (element["types"].includes("postal_code")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("locality") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_1") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_2") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_1") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("country") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        }
                    }

                    if (!final) {
                        final = data.results[0]["formatted_address"];
                    }

                    loc.val(final);
                    updateText = false;
                }
            };
            request.send();
        }

    </script>

</body>

</html>