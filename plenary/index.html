<!DOCTYPE html>
<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161890757-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-161890757-1');
    </script>

    <meta charset="UTF-8">
    <title>Plenary Sessions - CRS Time Calculator</title>
    <meta name="author" content="Sam Prausnitz-Weinbaum">
    <meta name="description"
        content="This website can tell you what time the CRS 2020 conference will be at in your local time!">
</head>

<body style="font-family: Arial, Helvetica, sans-serif;">
    <img src="../banner.jpg" width=100% />
    <span id="mobile-hide"><a href="/timecalc"><button><h2>‹Home</h2></button></a></span>
    <div style="text-align: center;">
        <h1>Welcome to the Controlled Release Society Plenary Session Time Calculator</h1>
    </div>
    <h3>Please enter your location:</h3>
    <div>
        <input type="text" id="loc" placeholder="Enter your location"
            style="width: 100%; height: 2em; font-size: larger;" />
    </div>
    <button id="go" style="height: 5%;font-size: larger; text-align: center; margin: 1em;">Update
        location</button>
    <br />
    <h3 id="time-label" style="background-color: white; display: inline-block; margin-bottom: 5px; font-size: 1.17em">Please enter your location</h3>
    <div style="text-align: left;" class="times">
        <h3 class="inner" id="live" style="background-color: white; display: inline-block; font-weight:normal">...</h3>
    </div>

    <div style="position: fixed; text-align: right; bottom: 0px; width: 100%;">
        <p style="padding-right: 15px;">Notice something wrong? <a href="mailto:sammypw1@gmail.com?Subject=CRS%20Time%20Calculator%20website%20feedback">Contact us</a>!</p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maps.google.com/maps/api/js?key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script>
        const loc = $("#loc");
        const go = $("#go");
        const live = $("#live");
        const liveTimes = [
            [[
                new Date("2020/06/29 04:30:00 -0400"),
                new Date("2020/06/29 16:30:00 -0400"),
                new Date("2020/06/30 13:30:00 -0400"),
                new Date("2020/07/01 01:30:00 -0400")
            ], "Yoshinori Ohsumi", 1],
            [[
                new Date("2020/06/29 14:00:00 -0400"),
                new Date("2020/06/30 02:00:00 -0400"),
                new Date("2020/06/30 04:00:00 -0400"),
                new Date("2020/06/30 16:00:00 -0400")
            ], "Katherine High", 1],
            [[
                new Date("2020/06/29 13:30:00 -0400"),
                new Date("2020/06/30 01:30:00 -0400"),
                new Date("2020/06/30 05:00:00 -0400"),
                new Date("2020/06/30 17:00:00 -0400")
            ], "The Magic of Bob Langer", 0.5],
            [[
                new Date("2020/06/29 05:30:00 -0400"),
                new Date("2020/06/29 17:30:00 -0400"),
                new Date("2020/06/30 13:00:00 -0400"),
                new Date("2020/07/01 01:00:00 -0400")
            ], "Mysteries, Mistakes, and Miracles", 0.5]
        ];
        const times = $(".times");
        times.hide();
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(navigator.userAgent)) {
            $("#mobile-hide").html('<a href="/"><h2>‹Home</h2></a');
        }
        const geocoder = new google.maps.Geocoder();
        let highlight = false;

        loc.click(function () {
            if (highlight) {
                $(this).select();
                highlight = false;
            }
        });

        go.click(handler);
        loc.on('keyup', function (e) {
            if (e.keyCode === 13) {
                handler();
            }
        });

        function handler() {
            $(".inner").text("...");
            geocoder.geocode({ 'address': loc.val() }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    const latitude = results[0].geometry.location.lat();
                    const longitude = results[0].geometry.location.lng();
                    displayLocation(latitude, longitude);
                    let timestamp = liveTimes[0][0][0].getTime() / 1000 + liveTimes[0][0][0].getTimezoneOffset() * 60;

                    const method = 'GET';
                    const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + latitude + ',' + longitude + '&timestamp=' + timestamp + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

                    request = new XMLHttpRequest();

                    request.open(method, url);
                    request.onload = function () {
                        if (request.status === 200) {
                            const data = JSON.parse(request.responseText);
                            const offsets = data.dstOffset * 1000 + data.rawOffset * 1000; // get DST and time zone offsets in milliseconds

                            const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };

                            let lTimes = []
                            for (let i = 0; i < 4; i ++) {
                                let programInner = i < 2 ? `<u>Plenary Talk ${i + 1}: ` : `<u>Special Session ${i - 1}: `;
                                programInner += `${liveTimes[i][1]}</u>`;
                                for (let j = 0; j < 4; j++) {
                                    let targetDate = liveTimes[i][0][j];
                                    timestamp = targetDate.getTime() / 1000 + targetDate.getTimezoneOffset() * 60;
                                    localdate = new Date(timestamp * 1000 + offsets);
                                    programInner += "<p style='padding-left: 1em; margin: 0.5em;'>" + localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(liveTimes[i][2], 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }) + (j == 0 ? " (LIVE)" : " (Repeat)") + "</p>";
                                }
                                lTimes.push(programInner);
                            }

                            $("#time-label").text("These sessions will take place at the following times:");
                            live.html(lTimes.join("<br>"));

                            times.show();
                        } else {
                            fail();
                        }
                    }
                    request.send();
                } else {
                    fail();
                }
            });
        }

        function fail() {
            times.hide();
            $("#time-label").text("Uh oh... something went wrong. Please try again.")
        }

        function getLocation() {
            if (navigator.geolocation) {
                loc.val("Retrieving location, please wait...");
                navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function geoSuccess(position) {
            let latitude = position.coords.latitude
            let longitude = position.coords.longitude;
            displayLocation(latitude, longitude);
            let timestamp = liveTimes[0][0][0].getTime() / 1000 + liveTimes[0][0][0].getTimezoneOffset() * 60;

            const method = 'GET';
            const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + latitude + ',' + longitude + '&timestamp=' + timestamp + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

            request = new XMLHttpRequest();

            request.open(method, url);
            request.onload = function () {
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    const offsets = data.dstOffset * 1000 + data.rawOffset * 1000; // get DST and time zone offsets in milliseconds

                    const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };

                    let lTimes = []
                    for (let i = 0; i < 4; i ++) {
                        let programInner = i < 2 ? `<u>Plenary Talk ${i + 1}: ` : `<u>Special Session ${i - 1}: `;
                        programInner += `${liveTimes[i][1]}</u>`;
                        for (let j = 0; j < 4; j++) {
                            let targetDate = liveTimes[i][0][j];
                            timestamp = targetDate.getTime() / 1000 + targetDate.getTimezoneOffset() * 60;
                            localdate = new Date(timestamp * 1000 + offsets);
                            programInner += "<p style='padding-left: 1em; margin: 0.5em;'>" + localdate.toLocaleDateString("en-US", options) + " - " + moment(localdate).add(liveTimes[i][2], 'h').toDate().toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit' }) + (j == 0 ? " (LIVE)" : " (Repeat)") + "</p>";
                        }
                        lTimes.push(programInner);
                    }

                    $("#time-label").text("These sessions will take place at the following times:");
                    live.html(lTimes.join("<br>"));

                    times.show();
                } else {
                    fail();
                }
            }
            request.send();
        }

        function geoError() {
            console.log("Geocoder failed.");
            loc.val("Could not get location, please enter your location");
            highlight = true;
        }
        $(getLocation);

        function displayLocation(latitude, longitude) {
            let request = new XMLHttpRequest();

            const method = 'GET';
            const url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + latitude + ',' + longitude + '&key=AIzaSyAb94zapDceVmspV65wFj_-iV2AWQk9kwY';

            request.open(method, url, true);
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    const data = JSON.parse(request.responseText);

                    let final = ""
                    for (let i = 0; i < data.results.length; i++) {
                        element = data.results[i]
                        if (element["types"].includes("postal_code")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("locality") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_1") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_2") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("administrative_area_level_1") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        } else if (element["types"].includes("country") && element["types"].includes("political")) {
                            final = element["formatted_address"];
                            break;
                        }
                    }

                    if (!final) {
                        final = data.results[0]["formatted_address"];
                    }

                    loc.val(final);
                    updateText = false;
                }
            };
            request.send();
        }

    </script>

</body>

</html>